services:
  # 1. Spark 및 파이프라인 실행 컨테이너 (공식 이미지로 교체)
  ueba-spark:
    container_name: ueba-spark
    image: apache/spark:3.5.0
    user: root
    volumes:
      - .:/UEBA
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=Asia/Seoul
      - PYTHONPATH=/UEBA             # [핵심] 모듈 인식 에러 방지
      - TARGET_ES_HOST=ueba-elasticsearch
      - TARGET_ES_PORT=9200
      - CONFIG_DIR=/UEBA/common/setup # [핵심] 설정파일 폴더 경로
    networks:
      - ueba-net
    command: tail -f /dev/null

  # 2. Elasticsearch (데이터 저장소)
  ueba-elasticsearch:
    container_name: ueba-elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g" 
      - TZ=Asia/Seoul
    ports:
      - "9200:9200"
    volumes:
      - ./data/elasticsearch:/usr/share/elasticsearch/data
    networks:
      - ueba-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 3. Kibana (시각화)
  ueba-kibana:
    container_name: ueba-kibana
    image: docker.elastic.co/kibana/kibana:8.12.2
    environment:
      - ELASTICSEARCH_HOSTS=http://ueba-elasticsearch:9200
      - I18N_LOCALE=ko-KR
    ports:
      - "5601:5601"
    networks:
      - ueba-net
    depends_on:
      ueba-elasticsearch:
        condition: service_healthy

  # 4. MariaDB (인사/HR 데이터베이스)
  ueba-mariadb:
    container_name: ueba-mariadb
    image: mariadb:10.6
    environment:
      - MYSQL_ROOT_PASSWORD=Suju!0901
      - MYSQL_DATABASE=UEBA_TEST
      - MYSQL_USER=ueba_user
      - MYSQL_PASSWORD=Suju!0901
    ports:
      - "13306:3306"
    networks:
      - ueba-net

  # 5. Postgres (기존 수집 대상)
  ueba-postgres:
    container_name: ueba-postgres
    image: postgres:15
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=Suju!0901
      - POSTGRES_DB=ueba_db
    ports:
      - "5433:5432"
    networks:
      - ueba-net

networks:
  ueba-net:
    driver: bridge